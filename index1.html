<!DOCTYPE html>
<html>
  <head>
    <title>Libros</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./style/style.css" />
    <link rel="icon" sizes="200x200" type="image/png" href="./style/books.png">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" type="text/css">
  </head>
  <body>
    <nav class="topnav">
      <a href="./index.html">Home</a> 
      <a href="./index1.html">Library</a>
      <a href="./index2.html">Drive</a>
    </nav>
    <div style="line-height:10px">
    <a href="./index.html"><img id="reader" src="./style/ereader.png" width = 52px style='float: left;'/></a>
    <h1><span class="black"><a href="./index.html">kindle</a></span></h1>
    <h1><a href="./index.html"><span class="grey">Digital</span> <span class="grey-light">Library </span></a></h1>
    </div>
        <h2>Directly from the Cloud</h2>
    <br/>
    <div align="center">
      <input type="text" id="Consulta" onkeyup="filterTable()" placeholder="Buscar un libro" title="Escribe un titulo o autor">
    </div>


    <a href="#" id="nextPage" style="display: none;" >Ver más &raquo;</a>

    <table style="display:none;" id="Libro">
    </table>

    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p id="book"> <p>
      </div>
    </div>

    <script src="./encode/base64js.min.js"></script>
    <script type="text/javascript">
      var CLIENT_ID = '983869916425-495k0u2mf6i377r6c04d1nkleek9qbbj.apps.googleusercontent.com';
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
      var SCOPES = 'https://www.googleapis.com/auth/drive';
     
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }
       
      function initClient() {
        gapi.client.init({
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        });
      }

      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {   
          listFiles("","fileExtension = 'azw3'");  <!-- si cambia usar name contains '.opf' -->
          createTable("Libros",["","Título","Autor","Año","Géneros","Formato"],"");
        } 
      }

      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn({ux_mode: "redirect"});
      }

      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut().then(function () {
          location.assign('./index.html');
        }); 
      }
	    
      function disconnect(event) {
        gapi.auth2.getAuthInstance().disconnect().then(function () {
          signoutButton.click();
        });
      }

      function listFiles(nextPageToken,query) {
        gapi.client.drive.files.list({
          pageSize: 50, //no puede ser menor a 4
          'pageToken': nextPageToken,
          includeTeamDrives : true,
          fields: "nextPageToken, files(id, name, mimeType, fileExtension, webContentLink, parents, properties)",
          q: query
        }).then(function(response) {
          var files = response.result.files;
          if (files && files.length > 0) {
            var nextPage = document.getElementById("nextPage");
            if (response.result.nextPageToken){
              nextPage.style.display="block";
              nextPage.setAttribute("onclick","listFiles('"+response.result.nextPageToken+"',"+'"'+query+'"'+")");
            }
            else{
              nextPage.style.display="none";
            }
            buildJson2(files);
          }
        });
      }

      function buildJson2(files) {
        for (var i = 0; i < files.length; i++) {
          var file = files[i]; 
          if (file.properties) {
          	 var metaData = file.properties;
          	 appendRow(file, metaData);
          }
          else {
 		    var delayInMilliseconds = 500; //1 second
	        setTimeout(openFile(file, 1), delayInMilliseconds); 
          }

	    }
      }

      function openFile(file, type) {
        var accessToken = gapi.auth.getToken().access_token;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', "https://www.googleapis.com/drive/v3/files/"+file.id+"?"+"alt=media");
        xhr.responseType = "blob";
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.send();  
        xhr.onload = function() {
        var bobFile = xhr.response;
          readMetadata(file, bobFile, type)
        };
        xhr.onerror = function() {
          console.log("Error");
        };  
      }


      function insertProperty(file, metaData) {
        var request=gapi.client.request( { 
        'path': '/drive/v3/files/'+file.id,
        'method': 'PATCH',
        'params': {'fileId': file.id},
        'body': {"properties": metaData}
        }).then( function (response) {
        	appendRow(file,metaData);
        }

        );
    }

  function readMetadata(file, bobFile, type) {
    var metaData={"title":"","creator":"","date":"","subject":"-"};
      var reader = new FileReader();
      reader.readAsArrayBuffer(bobFile);
      reader.onload = function(event) {
        var bookBob = reader.result;
        var view1 = new DataView(bookBob);
        var recordsNumber=view1.getUint16(76);
        var firsRecordOffset = view1.getUint32(78);
        var mobiHeaderIndex = 78+8*recordsNumber+2+16;
        var isMobi = view1.getUint32(mobiHeaderIndex);
        if (isMobi == 1297039945) {
          var firstImageIndex = view1.getUint32(mobiHeaderIndex+92)
          var bookBinary = new Uint8Array(bookBob);
          var bookTitleOffset = view1.getUint32(mobiHeaderIndex+68)+firsRecordOffset;
          var bookTitleLength = view1.getUint32(mobiHeaderIndex+72);
          var bookTitle = uintToString(bookBinary.slice(bookTitleOffset,bookTitleOffset+bookTitleLength));      
          metaData.title = bookTitle;
          var mobiHeaderLength=view1.getUint32(mobiHeaderIndex+4);
          var hasEXTH = view1.getUint32(mobiHeaderIndex+mobiHeaderLength);
          if (hasEXTH == 1163416648) {
            var exthHeaderIndex = mobiHeaderIndex+mobiHeaderLength; // dps vienen 8 bytes donde sale el string EXTH y el largo
            var recordCount = view1.getUint32(exthHeaderIndex+8); // cantidad de records que contiene
            var recordIndex = 0; //empieza la información del primer record, los primeros 4 bytes son el recordtype
            var recordType = 0;
            var recordLength = 0;
            for (var i=0; i<recordCount;i++){ 
              if (i==0) {
                var recordIndex = exthHeaderIndex+12;
              }
              else {
                recordIndex = recordIndex+recordLength;
              }
              var recordType = view1.getUint32(recordIndex);
              var recordLength = view1.getUint32(recordIndex+4);
              if (recordType == 100 && type==1){
                var author=uintToString(bookBinary.slice(recordIndex+8,recordIndex+recordLength));
                metaData.creator=author;
              }
              else if (recordType == 105 && type==1){
                var subject=uintToString(bookBinary.slice(recordIndex+8,recordIndex+recordLength));
		            if (metaData["subject"]=="-"){
		              metaData["subject"]=subject;
	              }
		            else {
		              metaData["subject"]=metaData["subject"]+"; "+subject;
		            }
              }
              else if (recordType == 106 && type==1){
                var date=uintToString(bookBinary.slice(recordIndex+8,recordIndex+recordLength));
                metaData.date = date.substring(0,4);
              }   
              else if (recordType == 103 && type==2){
                var description=uintToString(bookBinary.slice(recordIndex+8,recordIndex+recordLength));
                metaData.description=description;
              }  
              else if (recordType == 201 && type==2){
                var coverRecordIndex=view1.getUint32(recordIndex+8);
                var coverOffset = view1.getUint32(78+8*(firstImageIndex+coverRecordIndex));
                var endOffset = view1.getUint32(78+8*(firstImageIndex+coverRecordIndex+1));              
                var coverBase64=base64js.fromByteArray(bookBinary.slice(coverOffset,endOffset));
                metaData.cover=coverBase64;
              }                                        
            }
          }
        }
      if (type==1){
        insertProperty(file,metaData);
      }
      else {
        displayModal(metaData);
      }
      }
  }
  



      function createTable(id,headers,parent) {
        var table = document.createElement("TABLE");
        table.setAttribute("id", id);
        if (parent!=""){
          document.getElementById(parent).appendChild(table);
        }
        else {
          document.body.appendChild(table);
        }
        var header = table.createTHead();
        var row = header.insertRow(0);
        row.setAttribute("class","header");
        for (var i=0; i < headers.length; i++) {
          row.insertCell(i).innerHTML=headers[i];
        }
        var body = table.createTBody();
        return table;
      }

      function appendRow(file,metaData) {
      	metaData["subject"]=metaData["subject"].split(";");
        var table = document.getElementById("Libros").getElementsByTagName('tbody')[0];
        var table2 = document.getElementById("Libro");
        var row = table.insertRow(-1);
        row.insertCell(0).innerHTML= "<img width='40' src='./style/ebook.png'/>";	    
        var cell1 = row.insertCell(1);
        cell1.innerHTML= "<a onclick='openFile(this,2)' href='#myModal' id='"+file.id+"'>"+ metaData.title +"</a>"
/*        if (metaData.seriesTitle){
          cell1.innerHTML= "<a onclick='displayModal(this)' href='#Consulta'>"+ metaData.title +"</a>"+"<em><br>Serie: <a onclick='inputQuery(this)' href='#Consulta'>"+ metaData.seriesTitle +"</a> "+"("+metaData.seriesIndex+")</em>" ;
        }	*/    
        row.insertCell(2).innerHTML= "<a onclick='inputQuery(this)' href='#Consulta'>"+ metaData.creator +"</a>";
        row.insertCell(3).innerHTML= "<a onclick='inputQuery(this)' href='#Consulta'>"+ metaData.date +"</a>";
        subjects="-"
        for (i = 0; i < metaData.subject.length; i++) {
          if (i==0){
            subjects="<a onclick='inputQuery(this)' href='#Consulta'>"+metaData.subject[i]+"</a>";
          }
          else {
            subjects+=", <a onclick='inputQuery(this)' href='#Consulta'>"+metaData.subject[i]+"</a>";
          }
        }
        row.insertCell(4).innerHTML= subjects;	    
        var fileTypes="";
        if (file.fileExtension=="azw3"){
          fileTypes+="<a href='"+file.webContentLink+"'>.azw3</a> ";
        }
        if (file.fileExtension=="mobi"){
          fileTypes+="<a href='"+file.webContentLink+"'>.mobi</a>";
        }
        row.insertCell(5).innerHTML = fileTypes;
      }


      function appendRow2(file,metaData) {
        var table = document.getElementById("Libros").getElementsByTagName('tbody')[0];
        var table2 = document.getElementById("Libro");
        var row = table.insertRow(-1);
        var row2 = table2.insertRow(-1);
        row.insertCell(0).innerHTML= "<img width='40' src='./style/ebook.png'/>";
        row2.insertCell(0).innerHTML="<img src='data:image/jpeg;base64,"+metaData.cover+"'/>";		    
        var cell1 = row.insertCell(1);
        row2.id=metaData.title;
        cell1.innerHTML= "<a onclick='displayModal(this,metaData)' href='#Consulta'>"+ metaData.title +"</a>"
        if (metaData.seriesTitle!=""){
          cell1.innerHTML= "<a onclick='displayModal(this)' href='#Consulta'>"+ metaData.title +"</a>"+"<em><br>Serie: <a onclick='inputQuery(this)' href='#Consulta'>"+ metaData.seriesTitle +"</a> "+"("+metaData.seriesIndex+")</em>" ;
        }	    
        row.insertCell(2).innerHTML= "<a onclick='inputQuery(this)' href='#Consulta'>"+ metaData.creator +"</a>";
        row.insertCell(3).innerHTML= "<a onclick='inputQuery(this)' href='#Consulta'>"+ metaData.date +"</a>";
        subjects="-"
        for (i = 0; i < metaData.subject.length; i++) {
          if (i==0){
            subjects="<a onclick='inputQuery(this)' href='#Consulta'>"+metaData.subject[i]+"</a>";
          }
          else {
            subjects+=", <a onclick='inputQuery(this)' href='#Consulta'>"+metaData.subject[i]+"</a>";
          }
        }
        row.insertCell(4).innerHTML= subjects;
        row2.insertCell(1).innerHTML="<td valign='top' align='center'> <h1>"+metaData.title+"</h1> <br> <p align='justify'>"+metaData.description+"</p></td>";	    
        var fileTypes="";
        if (bookInfo.azw3!=""){
          fileTypes+="<a href='"+file.webContentLink+"'>.azw3</a> ";
        }
        if (bookInfo.mobi!=""){
          fileTypes+="<a href='"+file.webContentLink+"'>.mobi</a>";
        }
        row.insertCell(5).innerHTML = fileTypes;
      }

      function filterTable() {
        var input, filter, table, tr, td, i;
        input = document.getElementById("Consulta");
        filter = input.value.toUpperCase();
        table = document.getElementById("Libros");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
	  td1 = tr[i].getElementsByTagName("td")[1];
          td2 = tr[i].getElementsByTagName("td")[2];
          td3 = tr[i].getElementsByTagName("td")[3];
          td4 = tr[i].getElementsByTagName("td")[4];    
          if (td1 || td2 || td3 || td4) {
            if (td1.innerHTML.toUpperCase().indexOf(filter) > -1 || td2.innerHTML.toUpperCase().indexOf(filter) > -1 || td3.innerHTML.toUpperCase().indexOf(filter) > -1 || td4.innerHTML.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            }
            else {
	      tr[i].style.display = "none";
	    }
	  }
	}
      }

      function inputQuery(clickedElement) {
	document.getElementById("Consulta").value=clickedElement.innerHTML;
	filterTable();
      }
	    
      function uintToString(uintArray) {
        var encodedString = String.fromCharCode.apply(null, uintArray),
        decodedString = decodeURIComponent(escape(encodedString));
        return decodedString;
      }
	    

      function destroyTable(id) {
        var table = document.getElementById(id);
        var rows = table.rows.length;
        for (var i = 0; i < rows; i++) {
          table.deleteRow(0);
          console.log(table);
        }
      }

	    

      var modal = document.getElementById('myModal');
      var span = document.getElementsByClassName("close")[0];
	    
      function displayModal(metaData) {
        document.getElementById("book").innerHTML="<table id = 'Libro'><tr><td colspan='2'><h1>"+metaData.title+"</h1></td></tr><tr><td valign='center'><img width='230' src='data:image/jpeg;base64,"+metaData.cover+"'/></td><td valign='center' align='center'><p align='justify'>"+metaData.description+"</p></td></tr></table>"
        modal.style.display = "block";
      }
	    
      span.onclick = function() {
        destroyTable("Libro");
        modal.style.display = "none";
      }
    
      window.onclick = function(event) {
        if (event.target == modal) {
          destroyTable("Libro");
          modal.style.display = "none";
        }
      }
    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
