<!DOCTYPE html>
<html>
  <head>
    <title>BarCode Scanner</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./style/style.css" />
    <link rel="icon" sizes="200x200" type="image/png" href="./style/code.png">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" type="text/css">
  </head>
  <body>

    <div id='escaner'>
    </div>
    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="conectar" style="display: none;">Conectar Aplicaci贸n</button>
    <button id="desconectar" style="display: none;">Desconectar Aplicaci贸n</button>
    <button id="escanear" style="display: none;">Escanear</button>
    <button id="cerrar" style="display:none;">Cerrar</button>

    <form style="display: none" id="datos">
            <label for="codigo_articulo">C贸digo de Barra</label>
            <input type="text" id='codigo' placeholder="">
            <label for="descripcion_articulo">Descripci贸n del producto</label>
            <input type="text" id='descripcion' placeholder="">
            <label for="cantidad_articulo">Cantidad</label>
            <input type="number" id='cantidad' placeholder="">
    <button id="guardar" type="button">Guardar</button>  
    </form>
    <pre id="content"></pre>

      <script type="text/javascript">
      var CLIENT_ID = '983869916425-495k0u2mf6i377r6c04d1nkleek9qbbj.apps.googleusercontent.com';
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
      var SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.appfolder';

      var conectar = document.getElementById('conectar');
      var desconectar= document.getElementById('desconectar');
      var escanear= document.getElementById('escanear');
      var guardar = document.getElementById('guardar'); 
      guardar.disabled="true";
      document.getElementById('descripcion').addEventListener("change", validarDescripcion)
      var initialized=false;
      var idArchivo='';
	  var nombreHoja='';
      var baseDatos = {};

      function cargarCliente() {
        gapi.load('client:auth2', iniciarCliente);
      }
       
      function iniciarCliente() {
        gapi.client.init({
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          gapi.auth2.getAuthInstance().isSignedIn.listen(actualizarInicioCliente);
          actualizarInicioCliente(gapi.auth2.getAuthInstance().isSignedIn.get());
          conectar.onclick = autentificacionCliente;
          desconectar.onclick = desconectarCliente;
        });
      }

      function obtenerDatosApp() {
        gapi.client.drive.files.list({
          spaces: 'appDataFolder',
          fields: 'files(id,name)'
        }).then(function(response) {
          var archivos = response.result.files;
          if (archivos && archivos.length > 0) {
            var archivo = archivos[0];
            obtenerArchivo(archivo.name);
	        idArchivo=archivo.name;
          }    
         else {
		    crearArchivo();
	      }
        });
      }
      
      function crearDatosApp(fileId) {
        gapi.client.drive.files.create({
          resource: {
            name: fileId,
            parents: ['appDataFolder']
          },
          fields: 'id'
        }).then(function (data) {obtenerDatosApp();});
        
      };
   function obtenerArchivo(idArchivo) {
 	var request = gapi.client.sheets.spreadsheets.get({spreadsheetId: idArchivo});
        request.then(function(response) {
		data= response.result.sheets;
		var encontrarHoja=-1;
		//var nombreHoja = "";
		for (var i=0; i < data.length; i++)
		{
			if (data[i].properties.sheetId==0){			
				encontrarHoja=0;
				nombreHoja=data[i].properties.title;
			}
		}
		if (encontrarHoja==-1) {
			crearHoja(idArchivo);	
		}
		else {
			leerDatos(idArchivo,nombreHoja+"!A:E");	
		}

      	}, function(reason) {
       		console.error('error: ' + reason.result.error.message);
      	}); }
	      
	      
    function crearHoja(idArchivo) {
      var params = {spreadsheetId: idArchivo};
      var batchUpdateSpreadsheetRequestBody = {
        requests: [{"addSheet": {"properties": {"sheetId": 0,"title": "Datos Escaneados"}}}], 
      };
      var request = gapi.client.sheets.spreadsheets.batchUpdate(params, batchUpdateSpreadsheetRequestBody);
      request.then(function(response) {
        console.log(response.result);
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }   
	      
    function crearArchivo() {
      var spreadsheetBody = {"properties": {"title": "BarCodeScanner"},"sheets": [{"properties": {"sheetId": 0,"title": "Datos Escaneados"}}]}
      var request = gapi.client.sheets.spreadsheets.create({}, spreadsheetBody);
      request.then(function(response) {
        crearDatosApp(response.result.spreadsheetId);
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }

    function leerDatos(idArchivo, rango) {
	var params = {spreadsheetId: idArchivo,  range: rango};	   
	var request = gapi.client.sheets.spreadsheets.values.get(params);  
	request.then(function(response) {
        	datos= response.result.values;  
		if (!(datos === undefined)) {
			for (var i = 0; i < datos.length; i++) {
				var codigo= datos[i][0];
				var descripcion = datos[i][1];
				if (!(codigo in baseDatos)){ 
					baseDatos[codigo]=descripcion
				}
			}
         	}
         }, function(reason) {
             console.error('error: ' + reason.result.error.message);
         });	    
   }	      
    function validarDescripcion(){
        if(this.value.length > 0) { 
            guardar.disabled = false; 
        } else { 
            guardar.disabled = true;
        }
    }
   function leerBaseDatos(codigo) {
		var descripcion="";
		if (codigo in baseDatos){ 
                	descripcion = baseDatos[codigo];		
		}
                document.getElementById('escaner').style.display = 'none';
                document.getElementById('datos').style.display = 'block';
                document.getElementById('escanear').style.display = 'block';
                document.getElementById("codigo").value = codigo;
                document.getElementById("codigo").disabled = true;
		document.getElementById("descripcion").value = descripcion;
		if (descripcion.length>0){
                document.getElementById("descripcion").disabled = true;  
		}
   }
		
   function escribirBaseDatos(codigo, descripcion) {
		if (!(codigo in baseDatos)){ 
                	baseDatos[codigo]=descripcion;		
		}  
   }
	    
   function escribirDatos(fileId, range, information) {
      var params = {
        spreadsheetId: fileId,
        range: range,
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS'};
      var valueRangeBody = {'values': [information],'majorDimension':'ROWS'};
      var request = gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody);
      request.then(function(response) {
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }


      function actualizarInicioCliente(isSignedIn) {
        if (isSignedIn) {   
	  obtenerDatosApp();
	  conectar.style.display = 'none';
          desconectar.style.display = 'block';
          escanear.style.display = 'block';
        } 
        else {
          conectar.style.display = 'block';
          desconectar.style.display = 'none';
          escanear.style.display = 'none';
        }
      }

      function autentificacionCliente(event) {
        initialized=true;
        gapi.auth2.getAuthInstance().signIn({ux_mode: "redirect"});
      }

      function deslogeoCliente(event) {
        gapi.auth2.getAuthInstance().signOut().then(function () {
          location.reload();
        }); 
      }

      function desconectarCliente(event) {
        gapi.auth2.getAuthInstance().disconnect().then(function () {
          deslogeoCliente();
        });
      } 
    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};cargarCliente()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    <script src="jquery191.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/serratus/quaggaJS/dist/quagga.js"></script>
    <script src="barcode.js"></script>
  </body>
</html>
