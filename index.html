<!DOCTYPE html>
<html>
  <head>
    <title>BarCode Scanner</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./style/style.css" />
    <link rel="icon" sizes="200x200" type="image/png" href="./style/code.png">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" type="text/css">
  </head>
  <body>

    <div id='barcode-scanner'>
    </div>
    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" style="display: none;">Conectar Aplicaci贸n</button>
    <button id="signout_button" style="display: none;">Salir de Google</button>
    <button id="disconnect_button" style="display: none;">Desconectar Aplicaci贸n</button>
    <button id="scan_button" style="display: none;">Escanear</button>
    <button id="cerrar" style="display:none;">Cerrar</button>

    <form style="display: none" id="form_sku">
            <label for="Nombres">C贸digo de Barra</label>
            <input type="text" id='codigo_barra' placeholder="">
            <label for="circunscripcion">Descripci贸n del producto</label>
            <input type="text" id='descripcion' placeholder="">
            <label for="local">Cantidad</label>
            <input type="number" id='cantidad' placeholder="">
    <button id="save_button" type="button">Guardar</button>
        
    </form>
    <pre id="content"></pre>

      <script type="text/javascript">
      var DATABASE = {};
      var CLIENT_ID = '983869916425-495k0u2mf6i377r6c04d1nkleek9qbbj.apps.googleusercontent.com';
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
      var SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.appfolder';

      var authorizeButton = document.getElementById('authorize_button');
      var signoutButton = document.getElementById('signout_button');
      var disconnectButton = document.getElementById('disconnect_button');
      var scanButton= document.getElementById('scan_button');
      var saveButton = document.getElementById('save_button'); 
      saveButton.disabled="true";
      document.getElementById('descripcion').addEventListener("change", verify)
      var initialized=false;

      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }
       
      function initClient() {
        gapi.client.init({
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {

          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
          disconnectButton.onclick = disconnect;
        });
      }
	      

      function getAppDataFile() {
        gapi.client.drive.files.list({
          spaces: 'appDataFolder',
          fields: 'files(id,name)'
        }).then(function(response) {
          var files = response.result.files;
          if (files && files.length > 0) {
              var file = files[0];
              console.log(file.id);
          }    
         else {
		createAppDataFile();
	 }
      });
      }
      
      function createAppDataFile() {
        gapi.client.drive.files.create({
          resource: {
            name: '1UYFvau6chumF-t7izY-AtOB7TPX_hkEO34uLLWBdIKY',
            parents: ['appDataFolder']
          },
          fields: 'id'
        }).then(function (data) {getAppDataFile();});
        
      };
   function readExcel(fileId) {
 	var request = gapi.client.sheets.spreadsheets.get({spreadsheetId: fileId});
        request.then(function(response) {
		data= response.result.sheets;
		var findSheet=-1;
		for (var i=0; i < data.length; i++)
		{
			if (data[i].properties.sheetId==0){			
				findSheet=0;
			}
		}
		if (findSheet==-1) {
			createHoja(fileId);	
		}

      	}, function(reason) {
       		console.error('error: ' + reason.result.error.message);
      	}); }
	      
	      
    function createHoja(fileId) {
      var params = {
        spreadsheetId: fileId,
      };

      var batchUpdateSpreadsheetRequestBody = {
        requests: [{"addSheet": {"properties": {"sheetId": 0,"title": "prueba2"}}}], 
      };

      var request = gapi.client.sheets.spreadsheets.batchUpdate(params, batchUpdateSpreadsheetRequestBody);
      request.then(function(response) {
        console.log(response.result);
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }   
	      
    function createSheet() {
      var spreadsheetBody = {"sheets": [{"properties": {"sheetId": 0,"title": "prueba"}}]}

      var request = gapi.client.sheets.spreadsheets.create({}, spreadsheetBody);
      request.then(function(response) {
        console.log(response.result);
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }
   function readDataBase(fileId, range) {
	var params = {spreadsheetId: fileId,  range: range};	   
	var request = gapi.client.sheets.spreadsheets.values.get(params);  
	   readExcel(fileId);
	request.then(function(response) {
        	data= response.result.values;  
		if (!(data === undefined)) {
			for (var i = 0; i < data.length; i++) {
				var id = data[i][0];
				var description = data[i][1];
				if (!(id in DATABASE)){ 
					DATABASE[id]=description
				}
			}
         	}
         }, function(reason) {
             console.error('error: ' + reason.result.error.message);
         });	    
   }	      
    function verify(){
        if(this.value.length > 0) { 
            saveButton.disabled = false; 
        } else { 
            saveButton.disabled = true;
        }
    }
   function readCells(code) {
		var description="";
		if (code in DATABASE){ 
                	description = DATABASE[code];		
		}
                document.getElementById('barcode-scanner').style.display = 'none';
                document.getElementById('form_sku').style.display = 'block';
                document.getElementById('scan_button').style.display = 'block';
                document.getElementById("codigo_barra").value = code;
                document.getElementById("codigo_barra").disabled = true;
		document.getElementById("descripcion").value = description;
		if (description.length>0){
                document.getElementById("descripcion").disabled = true;  
		}
   }
		
   function writeCells(code, name) {
		if (!(code in DATABASE)){ 
                	DATABASE[code]=name;		
		}  
   }
	    
   function writeDataBase(fileId, range, information) {
      var params = {
        spreadsheetId: fileId,
        range: range,
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS'};
      var valueRangeBody = {'values': [information],'majorDimension':'ROWS'};
      var request = gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody);
      request.then(function(response) {
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }


      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {   
	  getAppDataFile();
	  readDataBase('1UYFvau6chumF-t7izY-AtOB7TPX_hkEO34uLLWBdIKY', 'Entradas!A:E');
	  authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          disconnectButton.style.display = 'block';
          scanButton.style.display = 'block';
        } 
        else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
          disconnectButton.style.display = 'none';
          scanButton.style.display = 'none';
        }
      }

      function handleAuthClick(event) {
        initialized=true;
        gapi.auth2.getAuthInstance().signIn({ux_mode: "redirect"});
      }

      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut().then(function () {
          location.reload();
        }); 
      }

      function disconnect(event) {
        gapi.auth2.getAuthInstance().disconnect().then(function () {
          signoutButton.click();
        });
      } 
    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    <script src="jquery191.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/serratus/quaggaJS/dist/quagga.js"></script>
    <script src="barcode.js"></script>
  </body>
</html>
