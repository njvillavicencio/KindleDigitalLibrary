<!DOCTYPE html>
<html>
  <head>
    <title>Libros</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" sizes="200x200" type="image/png" href="books.png">
  </head>
  <body>
    <h1 align="center">Mis libros</h1>
    <br />
    <div align="center">
    <input type="text" id="Consulta" placeholder="Buscar en Drive" title="Busqueda">
    </div>
    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" style="display: none;">Conectar Aplicación</button>
    <button id="signout_button" style="display: none;">Salir de Google</button>
    <button id="disconnect_button" style="display: none;">Desconectar Aplicación</button>
    <pre id="content"></pre>
    <table id="Navegacion">
    <tr class="header" >
      <th id="folders"> </th>
    </tr>
  </table>
  <table id="Libros">
    <tr class="header" >
      <th>Nombre</th>
      <th></th>
      <th>Propietario</th>
      <th>Última modificación</th>
      <th>Tamaño del archivo</th>
    </tr>
  </table>
  <a href="#" id="nextPage" style="display: none;" >Ver más &raquo;</a>

    <script type="text/javascript">
      var CLIENT_ID = '983869916425-495k0u2mf6i377r6c04d1nkleek9qbbj.apps.googleusercontent.com';
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
      var SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.appfolder';
      
      var authorizeButton = document.getElementById('authorize_button');
      var signoutButton = document.getElementById('signout_button');
      var disconnectButton = document.getElementById('disconnect_button');
      var initialized=false;

      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
       <!-- gapi.client.load('drive', 'v3'); -->
      }
       
      function initClient() {
        gapi.client.init({
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
          disconnectButton.onclick = disconnect;
          listFiles("","'root' in parents and (mimeType = 'application/vnd.google-apps.folder' or fileExtension = 'azw3' or fileExtension = 'mobi')");
        });
      }
      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          disconnectButton.style.display = 'block';
        } 
        else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
          disconnectButton.style.display = 'none';
        }
      }
      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        initialized=true;
        gapi.auth2.getAuthInstance().signIn({ux_mode: "redirect"});
      }
      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut().then(function () {
          location.assign('./index.html');
        }); 
      }
      function disconnect(event) {
        gapi.auth2.getAuthInstance().disconnect().then(function () {
          signoutButton.click();
        });
      }
      /**
       * Append a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} message Text to be placed in pre element.
       */
      /**
       * Print files.
       */

      var navFolders2={0: ["root","Mi unidad"]};
      var navFolders={"root": [0,"Mi unidad"]};
      var currDirectory="<a href='#' onclick='navigationMenu(this.id,"+"root"+")' id='root'>Mi unidad</a>";
      document.getElementById("folders").innerHTML=currDirectory;

      function buildJson(files) {
            for (var i = 0; i < files.length; i++) {
              var file = files[i];
              if (file.mimeType == "application/vnd.google-apps.folder" || file.fileExtension == "mobi" || file.fileExtension == "azw3") {
                var table = document.getElementById("Libros");
                var row = table.insertRow(-1);
                var cell0 = row.insertCell(0);
                var cell1 = row.insertCell(1);
                var cell2 = row.insertCell(2);
                owner="";
                for (var j=0; j < file.owners.length; j++){
                  if (file.owners[j].me){
                    owner = "yo";
                    break;
                  }
                  else {
                    owner = owner + file.owners[j].displayName;
                  }
                }
                cell2.innerHTML=owner;

                if (file.lastModifyingUser.me) {
                  row.insertCell(3).innerHTML=file.modifiedTime.substring(0,10)+ " yo";
                }
                else {
                  row.insertCell(3).innerHTML=file.modifiedTime.substring(0,10)+ " " + file.lastModifyingUser.displayName;
                }
                row.id=file.id;
                if (file.mimeType == "application/vnd.google-apps.folder") {
                  row.setAttribute("onclick","navigationMenu(this.id,'"+file.name+"')");
                  if (file.shared){
                    cell0.innerHTML="<img width='40' heigth='40' src='./sfi.png'/> ";
                  }
                  else {
                    cell0.innerHTML="<img width='40' heigth='40' src='./fi.png'/> ";
                  }
                  cell1.innerHTML=file.name;
                  row.insertCell(4).innerHTML="-";
                }
                else if (file.fileExtension == "mobi" || file.fileExtension == "azw3" ) {
                  row.setAttribute("onclick","download('"+file.webContentLink+"')");
                  cell0.innerHTML="<img width='37' heigth='37' src='./book.png'/>";
                  cell1.innerHTML=file.name;

                  
                  if (file.size/1000000 > 1){
                    row.insertCell(4).innerHTML=file.size/1000000 + " MB";
                  }
                  else {
                    row.insertCell(4).innerHTML=file.size/1000 + " KB";
                }
                }
              }
            }

          }

      function download(link){
        var anchor = document.createElement('a');
        anchor.href = link;
        anchor.target = '_blank';
        anchor.click();
      }

      function navigationMenu(folderId, folderName){
        if (Object.keys(navFolders).indexOf(folderId)==-1){
          navFolders[folderId]=[Object.keys(navFolders).length,folderName];
          navFolders2[Object.keys(navFolders2).length]=[folderId,folderName];
        }


        for (var id of Object.keys(navFolders)) {
          if (navFolders[id][0]> navFolders[folderId][0]){
            delete navFolders2[navFolders[id][0]]
            delete navFolders[id];
          }
        }


        currDirectory="";
        for (var i = 0; i<Object.keys(navFolders2).length ; i++) {
            if (i>0) { 
              currDirectory+=" > "+"<a href='#' onclick='navigationMenu(this.id,this.innerHTML)' id='"+ navFolders2[i][0]+"'>" +navFolders2[i][1] +"</a>";
              }
            else {
              currDirectory="<a href='#' onclick='navigationMenu(this.id,this.innerHTML)' id='"+ navFolders2[i][0]+"'>" +navFolders2[i][1] +"</a>";
            }
        }
        document.getElementById("folders").innerHTML=currDirectory;
        var query = "'"+folderId+"' in parents and (mimeType = 'application/vnd.google-apps.folder' or fileExtension = 'azw3' or fileExtension = 'mobi')";
        destroyTable(query);
      }

      function destroyTable(query) {
        var table = document.getElementById("Libros");
        var rows = table.rows.length;
        for (var i = 1; i < rows; i++) {
          table.deleteRow(1);
        }
        listFiles("",query);

      }

      function listFiles(nextPageToken,query) {
        gapi.client.drive.files.list({
          pageSize: 50,          
          includeTeamDrives : true,
          'pageToken': nextPageToken,    
          fields: "nextPageToken, files(id, name, mimeType, fileExtension, webContentLink, size, owners, modifiedTime, shared,lastModifyingUser)",
          q: query
        }).then(function(response) {
          var files = response.result.files;
          
          if (files && files.length > 0) {
            buildJson(files)
          }
          var nextPage = document.getElementById("nextPage");
          if (response.result.nextPageToken){
            nextPage.style.display="block";
            nextPage.setAttribute("onclick","listFiles('"+response.result.nextPageToken+"',"+'"'+query+'"'+")");
          }
          else{
            nextPage.style.display="none";
            
          }
        });
      }

      var input = document.getElementById("Consulta");
      input.addEventListener("keyup", function(event) {
        event.preventDefault();
        if (event.keyCode === 13) {
          var query = "name contains '"+input.value+"'";
          currDirectory="<a href='#' onclick='navigationMenu(this.id,"+"root"+")' id='root'>Mi unidad</a> > Resultados de la búsqueda";
          document.getElementById("folders").innerHTML=currDirectory;
          destroyTable(query);
        }
      });

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
